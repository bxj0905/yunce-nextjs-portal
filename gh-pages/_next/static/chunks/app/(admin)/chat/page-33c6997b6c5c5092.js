(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7142],{3968:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>c});var s=a(5155),r=a(2115),l=a(8240),i=a(4823),n=a(6766);let o="yunce_ai_chat_sessions_v1";function c(){var e;let t="/yunce-nextjs-portal",a=e=>e.startsWith("http")||t&&e.startsWith(t+"/")?e:"".concat(t).concat(e.startsWith("/")?"":"/").concat(e),[c,d]=(0,r.useState)([]),[u,h]=(0,r.useState)(""),m=(0,r.useMemo)(()=>{var e;return null!==(e=c.find(e=>e.id===u))&&void 0!==e?e:null},[c,u]),b=null!==(e=null==m?void 0:m.messages)&&void 0!==e?e:[],[g,x]=(0,r.useState)(""),v=(0,r.useRef)(null),p="sk-ff6ce9a6a943401c852bc0f3229e7148",[f,y]=(0,r.useState)(p),[j,w]=(0,r.useState)(!1),N={primary:"chat-bubble-primary",secondary:"chat-bubble-secondary",accent:"chat-bubble-accent",neutral:"chat-bubble-neutral",info:"chat-bubble-info",success:"chat-bubble-success",warning:"chat-bubble-warning",error:"chat-bubble-error"},k=(0,r.useMemo)(()=>a("/images/user/user-02.jpg"),[t]),E=(0,r.useMemo)(()=>a("/images/logo/logo-icon.svg"),[t]),S=()=>{var e,t;let a=g.trim();if(!a||!m)return;if(!f){alert("请先设置 DeepSeek API Key");return}let s={id:"m-".concat(Date.now()),role:"user",text:a,tone:"primary"};d(e=>e.map(e=>e.id===u?{...e,title:0===e.messages.length?a.slice(0,20):e.title,messages:[...e.messages,s]}:e)),x("");let r=[{role:"system",content:"你是云策AI助手。请始终使用中文回答。回答时先进行简短的内部思考（如果模型支持返回 reasoning/思考内容，将以思考区展示），最后给出清晰结论。"},...((null===(e=c.find(e=>e.id===u))||void 0===e?void 0:e.messages)||[]).slice(-20).map(e=>({role:e.role,content:e.text})),{role:"user",content:s.text}];w(!0),fetch("https://api.deepseek.com/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(f)},body:JSON.stringify({model:"deepseek-chat",messages:r,temperature:.7,stream:!0})}).then(async e=>{var t,a,s,r,l,i,n,o,c;if(!e.ok)throw Error(await e.text());let h=null===(t=e.body)||void 0===t?void 0:t.getReader();if(!h)throw Error("无法读取流");let m="m-".concat(Date.now(),"-ai");d(e=>e.map(e=>e.id===u?{...e,messages:[...e.messages,{id:m,role:"assistant",text:"",thinking:"",tone:"neutral"}]}:e));let b=new TextDecoder("utf-8"),g="",x=(e,t)=>{d(a=>a.map(a=>a.id===u?{...a,messages:a.messages.map(a=>a.id===m?{...a,text:(a.text||"")+(e||""),thinking:void 0!==t?(a.thinking||"")+t:a.thinking}:a)}:a))};for(;;){let{done:e,value:t}=await h.read();if(e)break;let d=(g+=b.decode(t,{stream:!0})).split(/\n/);for(let e of(g=d.pop()||"",d)){let t=e.trim();if(t&&t.startsWith("data:")){let e=t.replace(/^data:\s*/,"");if("[DONE]"===e)continue;try{let t=JSON.parse(e),d=null!==(o=null==t?void 0:null===(r=t.choices)||void 0===r?void 0:null===(s=r[0])||void 0===s?void 0:null===(a=s.delta)||void 0===a?void 0:a.content)&&void 0!==o?o:"",u=null!==(c=null==t?void 0:null===(n=t.choices)||void 0===n?void 0:null===(i=n[0])||void 0===i?void 0:null===(l=i.delta)||void 0===l?void 0:l.reasoning_content)&&void 0!==c?c:void 0;(d||u)&&x(d,u)}catch(e){}}}}}).catch(e=>{d(t=>t.map(t=>t.id===u?{...t,messages:[...t.messages,{id:"m-".concat(Date.now(),"-err"),role:"assistant",text:"调用失败：".concat(String(e)),tone:"error"}]}:t))}).finally(()=>{var e;w(!1),null===(e=v.current)||void 0===e||e.scrollTo({top:v.current.scrollHeight,behavior:"smooth"})}),null===(t=v.current)||void 0===t||t.scrollTo({top:v.current.scrollHeight,behavior:"smooth"})};r.useEffect(()=>{try{let e=localStorage.getItem(o);if(e){let t=JSON.parse(e);d(t),t.length>0&&h(t[0].id)}else{let e={id:"s-".concat(Date.now()),title:"新的对话",createdAt:Date.now(),messages:[{id:"m-".concat(Date.now()),role:"assistant",text:"您好，我是云策AI助手。有什么可以帮您？",tone:"info"}]};d([e]),h(e.id)}}catch(e){}},[]),r.useEffect(()=>{try{localStorage.setItem(o,JSON.stringify(c))}catch(e){}},[c]),r.useEffect(()=>{try{let e=localStorage.getItem("DEEPSEEK_API_KEY");e?y(e):y(p)}catch(e){y(p)}},[]);let D=()=>{let e={id:"s-".concat(Date.now()),title:"新的对话",createdAt:Date.now(),messages:[]};d(t=>[e,...t]),h(e.id)},_=e=>{if(d(t=>t.filter(t=>t.id!==e)),u===e){var t,a;h(null!==(a=null===(t=c.filter(t=>t.id!==e)[0])||void 0===t?void 0:t.id)&&void 0!==a?a:"")}},I=(e,t)=>{d(a=>a.map(a=>a.id===e?{...a,title:t}:a))};return(0,s.jsxs)("div",{className:"flex flex-col gap-4 sm:gap-6 h-[calc(100vh-2rem)]",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("h1",{className:"text-2xl font-semibold text-gray-800 dark:text-white",children:"大模型对话"}),(0,s.jsx)("button",{className:"btn btn-sm",onClick:D,children:"新建会话"})]}),(0,s.jsx)("div",{className:"rounded-2xl border border-gray-200 p-2 dark:border-gray-800 bg-white dark:bg-white/[0.03]",children:(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsxs)("div",{className:"dropdown",children:[(0,s.jsx)("div",{tabIndex:0,role:"button",className:"btn btn-sm",children:"会话历史"}),(0,s.jsx)("ul",{tabIndex:0,className:"dropdown-content menu p-2 shadow bg-base-100 rounded-box w-72 max-h-80 overflow-y-auto",children:c.map(e=>(0,s.jsxs)("li",{children:[(0,s.jsx)("a",{onClick:()=>h(e.id),className:"".concat(e.id===u?"active":""),children:(0,s.jsx)("span",{className:"truncate",children:e.title||"未命名会话"})}),e.id===u&&(0,s.jsxs)("div",{className:"px-2 py-2 flex items-center gap-2",children:[(0,s.jsx)("input",{className:"input input-bordered input-xs w-full",defaultValue:e.title,onBlur:t=>I(e.id,t.target.value.trim()||"未命名会话")}),(0,s.jsx)("button",{className:"btn btn-xs",onClick:()=>_(e.id),children:"删"})]})]},e.id))})]}),(0,s.jsx)("button",{className:"btn btn-sm",onClick:D,children:"新建会话"})]})}),(0,s.jsxs)("section",{className:"flex-1 flex flex-col",children:[(0,s.jsx)("div",{className:"rounded-2xl border border-gray-200 p-3 dark:border-gray-800 bg-white dark:bg-white/[0.03] mb-3",children:(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("input",{className:"input input-bordered w-full",placeholder:"请输入 DeepSeek API Key（仅保存在本地）",value:f,onChange:e=>y(e.target.value)}),(0,s.jsx)("button",{className:"btn",onClick:()=>{try{localStorage.setItem("DEEPSEEK_API_KEY",f.trim()),alert("API Key 已保存到本地浏览器")}catch(e){}},children:"保存"})]})}),(0,s.jsx)("div",{ref:v,className:"flex-1 overflow-y-auto rounded-2xl border border-gray-200 p-4 dark:border-gray-800 bg-white dark:bg-white/[0.03]",children:(0,s.jsx)("div",{className:"space-y-4",children:b.map(e=>{var t;let a="user"===e.role,r=null!==(t=e.tone)&&void 0!==t?t:a?"primary":"neutral",o=a?N[r]:e.tone&&"neutral"!==e.tone?N[r]:"";return(0,s.jsxs)("div",{className:"chat ".concat(a?"chat-end":"chat-start"),children:[(0,s.jsx)("div",{className:"chat-image avatar",children:(0,s.jsx)("div",{className:"w-10 rounded-full overflow-hidden bg-gray-100 dark:bg-gray-800",children:(0,s.jsx)(n.default,{src:a?k:E,alt:a?"User":"AI",width:40,height:40})})}),(0,s.jsx)("div",{className:"chat-bubble ".concat(o||""),children:(0,s.jsx)(l.oz,{remarkPlugins:[i.A],children:e.text})}),!a&&e.thinking&&(0,s.jsx)("div",{className:"chat-footer opacity-70 text-xs mt-1",children:(0,s.jsxs)("details",{children:[(0,s.jsx)("summary",{children:"思考过程"}),(0,s.jsx)("div",{className:"mt-1 prose prose-sm dark:prose-invert max-w-none",children:(0,s.jsx)(l.oz,{remarkPlugins:[i.A],children:e.thinking})})]})})]},e.id)})})}),(0,s.jsx)("div",{className:"rounded-2xl border border-gray-200 p-3 mt-4 dark:border-gray-800 bg-white dark:bg-white/[0.03]",children:(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("input",{className:"input input-bordered w-full",placeholder:"输入消息，按 Enter 发送",value:g,onChange:e=>x(e.target.value),onKeyDown:e=>{"Enter"===e.key&&(e.preventDefault(),S())}}),(0,s.jsx)("button",{className:"btn btn-primary",onClick:S,disabled:!m||j,children:j?"发送中":"发送"})]})})]})]})}},7372:(e,t,a)=>{Promise.resolve().then(a.bind(a,3968))}},e=>{var t=t=>e(e.s=t);e.O(0,[3063,9788,8441,1684,7358],()=>t(7372)),_N_E=e.O()}]);