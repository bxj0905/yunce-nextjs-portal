(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7142],{225:(e,t,s)=>{Promise.resolve().then(s.bind(s,3968))},3968:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>x});var a=s(5155),l=s(2115),n=s(8240),i=s(4823),r=s(6766),c=s(5695);let o="yunce_ai_chat_sessions_v1";function d(e){let{loaded:t,activeSession:s,bootAsked:a,setBootAsked:n,handleSend:i}=e,r=(0,c.useSearchParams)();return l.useEffect(()=>{if(!t||!s||a)return;let e=((null==r?void 0:r.get("q"))||"").trim();e&&(n(!0),Promise.resolve().then(()=>i(e)))},[t,s,a,i,r]),null}function x(){var e;let t="/yunce-nextjs-portal",s=(0,l.useCallback)(e=>e.startsWith("http")||t&&e.startsWith(t+"/")?e:"".concat(t).concat(e.startsWith("/")?"":"/").concat(e),[t]),[c,x]=(0,l.useState)([]),[h,m]=(0,l.useState)(""),u=(0,l.useMemo)(()=>{var e;return null!==(e=c.find(e=>e.id===h))&&void 0!==e?e:null},[c,h]),g=null!==(e=null==u?void 0:u.messages)&&void 0!==e?e:[],[p,f]=(0,l.useState)(""),v=(0,l.useRef)(null),[j,w]=(0,l.useState)(!1),[b,y]=(0,l.useState)(!1),[k,N]=(0,l.useState)(!1),C=(0,l.useRef)(null),[S,D]=(0,l.useState)([]),z=(0,l.useMemo)(()=>s("/images/user/user-02.jpg"),[s]),A=(0,l.useMemo)(()=>s("/images/logo/logo-icon.svg"),[s]),M=e=>{let t=null!=e?e:"";for(let{think:e,concl:n}of[{think:/(?:^|\n)\s*(?:思考|思考区|Thinking)[:：]\s*/i,concl:/(?:^|\n)\s*(?:结论|Conclusion)[:：]\s*/i}]){var s,a,l;let i=t.match(e),r=t.match(n);if(i&&r){let e=(null!==(s=i.index)&&void 0!==s?s:0)+i[0].length,l=null!==(a=r.index)&&void 0!==a?a:-1;if(l>e)return{thinking:t.substring(e,l).trim(),conclusion:t.substring(l+r[0].length).trim()}}if(i&&!r){let e=(null!==(l=i.index)&&void 0!==l?l:0)+i[0].length;return{thinking:t.substring(e).trim(),conclusion:null}}}return null},T=(0,l.useCallback)(e=>{var t,a;let l=[(null!=e?e:p).trim(),S.map(e=>{let t="[附件:".concat(e.name,", ").concat(Math.ceil(e.size/1024),"KB]");return e.text?"".concat(t,"\n\n").concat(e.text):"".concat(t,"（非文本预览，需说明处理需求）")}).join("\n\n")].filter(Boolean).join("\n\n");if(!l||!u)return;let n={id:"m-".concat(Date.now()),role:"user",text:l,tone:"primary"};x(e=>e.map(e=>e.id===h?{...e,title:0===e.messages.length?l.slice(0,20):e.title,messages:[...e.messages,n]}:e)),e||f(""),D([]);let i=[{role:"system",content:"你是云策AI助手。请始终使用中文回答。回答时先进行简短的内部思考（如果模型支持返回 reasoning/思考内容，将以思考区展示），最后给出清晰结论。"},...((null===(t=c.find(e=>e.id===h))||void 0===t?void 0:t.messages)||[]).slice(-20).map(e=>({role:e.role,content:e.text})),{role:"user",content:n.text}];w(!0),fetch(s("/api/ai/chat"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:i,temperature:.7})}).then(async e=>{var t,s,a;if(!e.ok)throw Error(await e.text());let l=null===(t=e.body)||void 0===t?void 0:t.getReader();if(!l)throw Error("无法读取流");let n="m-".concat(Date.now(),"-ai");x(e=>e.map(e=>e.id===h?{...e,messages:[...e.messages,{id:n,role:"assistant",text:"",thinking:"",tone:"neutral"}]}:e));let i=new TextDecoder("utf-8"),r="",c=(e,t)=>{x(s=>s.map(s=>s.id===h?{...s,messages:s.messages.map(s=>s.id===n?{...s,text:(s.text||"")+(e||""),thinking:void 0!==t?(s.thinking||"")+t:s.thinking}:s)}:s))};for(;;){let{done:e,value:t}=await l.read();if(e)break;let n=(r+=i.decode(t,{stream:!0})).split(/\n/);for(let e of(r=n.pop()||"",n)){let t=e.trim();if(t)try{let e=JSON.parse(t),l=null!==(s=null==e?void 0:e.delta)&&void 0!==s?s:"",n=null!==(a=null==e?void 0:e.reasoning)&&void 0!==a?a:void 0;(l||n)&&c(l,n)}catch(e){}}}}).catch(e=>{x(t=>t.map(t=>t.id===h?{...t,messages:[...t.messages,{id:"m-".concat(Date.now(),"-err"),role:"assistant",text:"调用失败：".concat(String(e)),tone:"error"}]}:t))}).finally(()=>{var e;w(!1),null===(e=v.current)||void 0===e||e.scrollTo({top:v.current.scrollHeight,behavior:"smooth"})}),null===(a=v.current)||void 0===a||a.scrollTo({top:v.current.scrollHeight,behavior:"smooth"})},[h,u,p,c,s,S]);l.useEffect(()=>{try{let e=localStorage.getItem(o);if(e){let t=JSON.parse(e);x(t),t.length>0&&m(t[0].id)}else x([])}catch(e){}y(!0)},[]),l.useEffect(()=>{try{localStorage.setItem(o,JSON.stringify(c))}catch(e){}},[c]),l.useEffect(()=>{if(!b)return;let e={id:"s-".concat(Date.now()),title:"新的对话",createdAt:Date.now(),messages:[]};x(t=>[e,...t]),m(e.id)},[b]);let E=e=>{if(x(t=>t.filter(t=>t.id!==e)),h===e){var t,s;m(null!==(s=null===(t=c.filter(t=>t.id!==e)[0])||void 0===t?void 0:t.id)&&void 0!==s?s:"")}},H=e=>{try{navigator.clipboard.writeText(e)}catch(e){}},_=l.useMemo(()=>{let e=new Date;e.setHours(0,0,0,0);let t=new Date(e);t.setDate(e.getDate()-1);let s=[],a=[],l=[];for(let n of c){let i=new Date(n.createdAt);i>=e?s.push(n):i>=t?a.push(n):l.push(n)}return{today:s,yesterday:a,earlier:l}},[c]);return(0,a.jsxs)(l.Suspense,{fallback:(0,a.jsx)("div",{}),children:[(0,a.jsx)(d,{loaded:b,activeSession:u,bootAsked:k,setBootAsked:N,handleSend:T}),(0,a.jsxs)("div",{className:"flex flex-col gap-4 sm:gap-6 h-[calc(100vh-2rem)]",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("h1",{className:"text-2xl font-semibold text-gray-800 dark:text-white",children:"大模型对话"}),(0,a.jsx)("div",{})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-12 gap-4 sm:gap-6 flex-1 min-h-0",children:[(0,a.jsx)("aside",{className:"lg:col-span-3 xl:col-span-3 2xl:col-span-3 flex flex-col gap-4 min-h-0",children:(0,a.jsxs)("div",{className:"rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-white/[0.03] p-4 flex flex-col flex-1 min-h-0",children:[(0,a.jsx)("button",{className:"btn btn-primary w-full mb-3",onClick:()=>{let e={id:"s-".concat(Date.now()),title:"新的对话",createdAt:Date.now(),messages:[]};x(t=>[e,...t]),m(e.id)},children:"+ New Chat"}),(0,a.jsx)("div",{className:"mb-3",children:(0,a.jsx)("input",{className:"input input-bordered w-full",placeholder:"Search..."})}),(0,a.jsxs)("div",{className:"flex-1 overflow-y-auto pr-1",children:[_.today.length>0&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"text-xs uppercase tracking-wide text-gray-400 mb-2",children:"Today"}),(0,a.jsx)("ul",{className:"menu w-full mb-4",children:_.today.map(e=>(0,a.jsx)("li",{children:(0,a.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,a.jsx)("a",{onClick:()=>m(e.id),className:"flex-1 ".concat(e.id===h?"active":""),children:(0,a.jsx)("span",{className:"truncate",children:e.title||"未命名会话"})}),(0,a.jsx)("button",{className:"btn btn-ghost btn-xs btn-square",title:"删除",onClick:()=>E(e.id),children:(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",className:"w-4 h-4 opacity-80",children:(0,a.jsx)("path",{d:"M9 3.75A1.5 1.5 0 0 1 10.5 2.25h3A1.5 1.5 0 0 1 15 3.75V5h4.25a.75.75 0 0 1 0 1.5H4.75a.75.75 0 0 1 0-1.5H9V3.75ZM6.75 7.5h10.5l-.674 11.08a2.25 2.25 0 0 1-2.244 2.07H9.668a2.25 2.25 0 0 1-2.244-2.07L6.75 7.5Zm3.5 2.25a.75.75 0 0 0-1.5 0l.375 8.25a.75.75 0 1 0 1.5 0L10.25 9.75Zm4.5 0a.75.75 0 0 0-1.5 0l-.375 8.25a.75.75 0 1 0 1.5 0l.375-8.25Z"})})})]})},e.id))})]}),_.yesterday.length>0&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"text-xs uppercase tracking-wide text-gray-400 mb-2",children:"Yesterday"}),(0,a.jsx)("ul",{className:"menu w-full mb-4",children:_.yesterday.map(e=>(0,a.jsx)("li",{children:(0,a.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,a.jsx)("a",{onClick:()=>m(e.id),className:"flex-1 ".concat(e.id===h?"active":""),children:(0,a.jsx)("span",{className:"truncate",children:e.title||"未命名会话"})}),(0,a.jsx)("button",{className:"btn btn-ghost btn-xs btn-square",title:"删除",onClick:()=>E(e.id),children:(0,a.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",className:"w-4 h-4 opacity-80",children:(0,a.jsx)("path",{d:"M9 3.75A1.5 1.5 0 0 1 10.5 2.25h3A1.5 1.5 0 0 1 15 3.75V5h4.25a.75.75 0 0 1 0 1.5H4.75a.75.75 0 0 1 0-1.5H9V3.75ZM6.75 7.5h10.5l-.674 11.08a2.25 2.25 0 0 1-2.244 2.07H9.668a2.25 2.25 0 0 1-2.244-2.07L6.75 7.5Zm3.5 2.25a.75.75 0 0 0-1.5 0l.375 8.25a.75.75 0 1 0 1.5 0L10.25 9.75Zm4.5 0a.75.75 0 0 0-1.5 0l-.375 8.25a.75.75 0 1 0 1.5 0l.375-8.25Z"})})})]})},e.id))})]}),0===_.today.length&&0===_.yesterday.length&&0===_.earlier.length&&(0,a.jsx)("div",{className:"opacity-60 px-2 py-1 text-xs",children:"暂无会话"})]})]})}),(0,a.jsxs)("section",{className:"lg:col-span-9 xl:col-span-9 2xl:col-span-9 flex flex-col min-h-0",children:[(0,a.jsx)("div",{ref:v,className:"flex-1 overflow-y-auto rounded-2xl border border-gray-200 p-4 dark:border-gray-800 bg-white dark:bg-white/[0.03] min-h-0",children:(0,a.jsx)("div",{className:"space-y-4",children:g.map(e=>{let t="user"===e.role,s=t?null:M(e.text);return(0,a.jsx)("div",{className:"flex w-full ".concat(t?"justify-end":"justify-start"),children:(0,a.jsxs)("div",{className:"flex items-start gap-3 max-w-[85%] ".concat(t?"flex-row-reverse":""),children:[(0,a.jsx)("div",{className:"w-10 h-10 rounded-full overflow-hidden bg-gray-100 dark:bg-gray-800 flex-shrink-0",children:(0,a.jsx)(r.default,{src:t?z:A,alt:t?"User":"AI",width:40,height:40})}),(0,a.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,a.jsxs)("div",{className:"rounded-2xl px-4 py-3 shadow-sm border ".concat(t?"bg-primary/10 border-primary/20":"bg-gray-50 dark:bg-white/5 border-gray-200 dark:border-gray-800"," w-auto inline-block"),children:[s?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("details",{className:"mt-0",open:!0,children:[(0,a.jsx)("summary",{className:"text-[11px] uppercase tracking-wide text-gray-500 dark:text-gray-400",children:"Thinking"}),(0,a.jsx)("div",{className:"mt-2 whitespace-pre-wrap text-[13px] leading-6 text-indigo-600 dark:text-indigo-400",children:(0,a.jsx)(n.oz,{remarkPlugins:[i.A],children:s.thinking})})]}),s.conclusion&&(0,a.jsx)("div",{className:"mt-3 prose prose-sm dark:prose-invert max-w-none text-gray-900 dark:text-gray-100",children:(0,a.jsx)(n.oz,{remarkPlugins:[i.A],children:s.conclusion})})]}):(0,a.jsx)("div",{className:"prose prose-sm dark:prose-invert max-w-none text-gray-900 dark:text-gray-100",children:(0,a.jsx)(n.oz,{remarkPlugins:[i.A],children:e.text})}),!t&&e.thinking&&(0,a.jsxs)("details",{className:"mt-3",children:[(0,a.jsx)("summary",{className:"text-[11px] uppercase tracking-wide text-gray-500 dark:text-gray-400",children:"Thinking"}),(0,a.jsx)("div",{className:"mt-2 whitespace-pre-wrap text-[13px] leading-6 text-indigo-600 dark:text-indigo-400",children:(0,a.jsx)(n.oz,{remarkPlugins:[i.A],children:e.thinking})})]})]}),(0,a.jsx)("div",{className:"mt-2 ".concat(t?"text-right":"text-left"),children:(0,a.jsx)("button",{className:"btn btn-ghost btn-xs",onClick:()=>H(e.text),children:"复制"})})]})]})},e.id)})})}),(0,a.jsx)("div",{className:"rounded-2xl border border-gray-200 p-3 mt-4 dark:border-gray-800 bg-white dark:bg-white/[0.03]",children:(0,a.jsxs)("div",{className:"flex items-stretch gap-3",children:[S.length>0&&(0,a.jsxs)("div",{className:"basis-1/3 max-w-[33%] min-w-0 flex flex-col gap-2",children:[(0,a.jsx)("input",{ref:C,type:"file",className:"hidden",multiple:!1,onChange:async e=>{var t;let s=e.currentTarget,a=null===(t=s.files)||void 0===t?void 0:t[0];if(a){try{if(/^text\//.test(a.type)||["application/json","text/csv"].includes(a.type)){let e=(await a.text()).slice(0,4e3);D(t=>[...t,{id:"att-".concat(Date.now()),name:a.name,size:a.size,type:a.type||"text/plain",text:e}])}else D(e=>[...e,{id:"att-".concat(Date.now()),name:a.name,size:a.size,type:a.type||"application/octet-stream"}])}catch(e){}s&&(s.value="")}}}),(0,a.jsx)("button",{className:"btn btn-ghost btn-sm w-fit",title:"附件",onClick:()=>{var e;return null===(e=C.current)||void 0===e?void 0:e.click()},children:"附件"}),(0,a.jsx)("div",{className:"flex flex-col gap-2 w-full max-h-40 overflow-y-auto pr-1",children:S.map(e=>(0,a.jsxs)("div",{className:"flex items-center justify-between px-3 py-2 rounded-xl bg-gray-100 text-gray-700 text-xs dark:bg-neutral-700 dark:text-neutral-200",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 min-w-0 w-full",children:[(0,a.jsxs)("svg",{className:"w-4 h-4 flex-shrink-0",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,a.jsx)("path",{d:"M15.5 14.5 8 22H2v-6l7.5-7.5"}),(0,a.jsx)("path",{d:"M16 5 19 8"})]}),(0,a.jsx)("span",{className:"truncate w-full",title:"".concat(e.name," (").concat(Math.ceil(e.size/1024),"KB)"),children:e.name})]}),(0,a.jsx)("button",{className:"btn btn-ghost btn-xs ml-2",onClick:()=>D(t=>t.filter(t=>t.id!==e.id)),title:"移除",children:"\xd7"})]},e.id))})]}),(0,a.jsxs)("div",{className:"flex-1 min-w-0 flex items-stretch gap-2",children:[0===S.length&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("input",{ref:C,type:"file",className:"hidden",onChange:async e=>{var t;let s=e.currentTarget,a=null===(t=s.files)||void 0===t?void 0:t[0];if(a){try{if(/^text\//.test(a.type)||["application/json","text/csv"].includes(a.type)){let e=(await a.text()).slice(0,4e3);D(t=>[...t,{id:"att-".concat(Date.now()),name:a.name,size:a.size,type:a.type||"text/plain",text:e}])}else D(e=>[...e,{id:"att-".concat(Date.now()),name:a.name,size:a.size,type:a.type||"application/octet-stream"}])}catch(e){}s&&(s.value="")}}}),(0,a.jsx)("button",{className:"btn btn-ghost btn-sm self-start",title:"附件",onClick:()=>{var e;return null===(e=C.current)||void 0===e?void 0:e.click()},children:"附件"})]}),(0,a.jsx)("textarea",{rows:1,className:"textarea textarea-bordered w-full h-full min-h-[44px] resize-none",placeholder:"输入消息，按 Enter 发送",value:p,onChange:e=>f(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),T())}}),(0,a.jsx)("button",{className:"btn btn-primary btn-circle self-center ".concat(!u||j?"btn-disabled":""),onClick:()=>T(),disabled:!u||j,title:"发送",children:j?(0,a.jsx)("span",{className:"loading loading-spinner loading-xs"}):(0,a.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",className:"w-4 h-4",children:[(0,a.jsx)("path",{d:"M22 2L11 13"}),(0,a.jsx)("path",{d:"M22 2l-7 20-4-9-9-4 20-7z"})]})})]})]})})]})]})]})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[3063,2682,8441,1684,7358],()=>t(225)),_N_E=e.O()}]);